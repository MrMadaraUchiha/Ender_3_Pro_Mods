[include fluidd.cfg]
[include /home/pi/klipper_config/extras/*.cfg]

[printer]
kinematics: limited_cartesian
max_velocity: 500
max_x_velocity: 400
max_y_velocity: 300
max_z_velocity: 10
max_accel: 17000
max_x_accel: 15400
max_y_accel: 8000
max_z_accel: 100
#scale_xy_accel: True
max_accel_to_decel: 13000
square_corner_velocity: 15

# [printer]
# kinematics: cartesian
# max_velocity: 350
# max_accel: 5900 #5300 for tall prints
# max_accel_to_decel: 99999
# square_corner_velocity: 20
# max_z_velocity: 10 #5
# max_z_accel: 100 #100

[input_shaper] 
shaper_type_x: mzv
shaper_freq_x: 72.4
damping_ratio_x: 0.08
shaper_type_y: mzv      
shaper_freq_y: 52.2
damping_ratio_y: 0.068
[resonance_tester]
accel_chip: adxl345
accel_per_hz: 135
hz_per_sec: .5
#method: pulses      ###
#max_accel: 10000    ###
probe_points:
    117.5,117.5,20
    117.5,117.5,125
    #117.5,117.5,250
[adxl345]
cs_pin: rpi:None
axes_map: -x,y,z

[extruder]
step_pin: PD5
dir_pin: PD6
enable_pin: !PD4
full_steps_per_rotation: 200
microsteps: 128
gear_ratio: 50:8
rotation_distance: 22.77428
nozzle_diameter: 0.6
filament_diameter: 1.75
max_extrude_only_distance: 200
max_extrude_only_velocity: 40 #75
max_extrude_only_accel: 6000
pressure_advance: .031
pressure_advance_smooth_time: 0.006
#[hotend]
heater_pin: PB3
sensor_pin: PC0
sensor_type: PT1000
pullup_resistor: 4700
min_temp: 0
max_temp: 400
smooth_time: 0.1
min_extrude_temp: 0

[tmc2209 extruder]
uart_pin: PA15
interpolate: False
sense_resistor: 0.110
run_current: 0.336 # results in CS 10
driver_TBL: 1
driver_TOFF: 3 # 41.7Khz max chopper frequency
driver_HSTRT: 0
driver_HEND: 3

[firmware_retraction]
retract_length: .3     #TUNING_TOWER COMMAND=SET_RETRACTION PARAMETER=RETRACT_LENGTH START=1.2 FACTOR=.05
retract_speed: 30       #TUNING_TOWER COMMAND=SET_RETRACTION PARAMETER=RETRACT_SPEED START=18 FACTOR=2
unretract_speed: 30     #TUNING_TOWER COMMAND=SET_RETRACTION PARAMETER=unretract_speed START=15 FACTOR=.25
unretract_extra_length: 0

#[verify_heater extruder]
#check_gain_time: 300
#max_error: 500 #120
#hysteresis: 10

[stepper_x]
step_pin: PE11
dir_pin: PE10
enable_pin: !PE9
microsteps: 128
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop  #^PB14  # PA1 for X-max
position_min: -22
position_endstop: -22
position_max: 240
homing_retract_dist: 0
homing_speed: 50.0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: PE8
run_current: .58
interpolate: False
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 0
sense_resistor: 0.110
diag_pin: ^PB14 #connected to X- Endstop (X Jumper Header) # Place a jumper on the two pin header near the endstop for sensorless homing
driver_SGTHRS: 97 #120 max, 85min

[stepper_y]
step_pin: PD8
dir_pin: PB12
enable_pin: !PD9
microsteps: 128
rotation_distance: 40
endstop_pin: ^PB13  # PA2 for Y-max
position_min: -2
position_endstop: -2
position_max: 235
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC4
run_current: .704
interpolate: False
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 0
sense_resistor: 0.110
# Place a jumper on the two pin header near the endstop for sensorless homing
#diag_pin: PB14 #connected to X- Endstop (X Jumper Header)
# You may need to tune this value.  See https://www.klipper3d.org/TMC_Drivers.html#sensorless-homing
#driver_SGTHRS: 115

[stepper_z]
step_pin: PD14
dir_pin: !PD13
enable_pin: !PD15
microsteps: 64
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop #^PA0 z min #PA3 for Z-max
#position_endstop: 0
position_max: 250
position_min: -3

[tmc2209 stepper_z]
uart_pin: PD12
run_current: .58
interpolate: False
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 0
sense_resistor: 0.110

[stepper_z1] #"E1" on mcu
step_pin: PE6
dir_pin: !PC13
enable_pin: !PE5
microsteps: 64
rotation_distance: 8
# heater_pin: PB4
# sensor_pin: PC1

[tmc2209 stepper_z1]
uart_pin: PC5
run_current: .58
interpolate: False
driver_TBL: 1
driver_TOFF: 3
driver_HSTRT: 0
driver_HEND: 0
sense_resistor: 0.110

#[extruder2]
#step_pin: PE2
#dir_pin: !PE4
#enable_pin: !PE3
#heater_pin: PB15
#sensor_pin: PC2
#[tmc2209 extruder2]
#uart_pin: PE0
#run_current: 0.8

[heater_bed]
heater_pin: PC8
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC3
min_temp: 0
max_temp: 110
smooth_time: 0.1
#control = pid
#pid_Kp: 69.597
#pid_Ki: 1.578
#pid_Kd: 767.303

#fan for printed model (FAN0 - PB0 is broken)
[fan]
pin: PB1
max_power: 1.0
kick_start_time: 0.500

#fan for hotend FAN1
[heater_fan HE_fan]
pin: PB2
shutdown_speed: 1
max_power: 1
#hardware_pwm: false
#kick_start_time: 0.500
heater: extruder
heater_temp: 50
fan_speed: .5 #1.00

[temperature_sensor Heatsink] 
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1

# [temperature_fan HE_fan]
# pin: PB2
# shutdown_speed: 1
# max_power: 1.0
# sensor_type: EPCOS 100K B57560G104F
# sensor_pin: PC1
# target_temp: 45
# min_temp:0
# max_temp:50
# control: pid
# pid_kp = 30 #25.870
# pid_ki = 1.380
# pid_kd = 121.264
# min_speed: 0.25
# off_below: 0.28

#fan for control board FAN2
[controller_fan MCU_fan]
pin: PB5
max_power: 1.0
kick_start_time: 0.500
fan_speed: 1.00
shutdown_speed: 1
idle_timeout: 60
heater: heater_bed

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_2F0057000851363131363530-if00
baud: 250000
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[temperature_sensor Pi] 
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

#Gcode G2/G3 Arc Support
[gcode_arcs]
resolution: 0.1

[skew_correction]
[display_status]
[pause_resume]
[respond]
[virtual_sdcard]
path: ~/sdcard
[exclude_object]
[skew_correction]

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC9, EXP1_2=PA8,
    EXP1_3=PC11, EXP1_4=PD2,
    EXP1_5=PC10, EXP1_6=PC12,    # Slot in the socket on this side
    EXP1_7=PD0, EXP1_8=PD1,
    EXP1_9=<GND>, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PC6, EXP2_4=PA4,
    EXP2_5=PC7, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PB10, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

[display]
lcd_type: st7920
cs_pin: EXP1_7
sclk_pin: EXP1_6
sid_pin: EXP1_8
encoder_pins: ^EXP1_5, ^EXP1_3
click_pin: ^!EXP1_2

[output_pin _beeper]
pin: EXP1_1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bed_mesh 60C]
#*# version = 1
#*# points =
#*# 	0.023750, -0.008750, -0.015000, -0.026250, -0.059375, -0.066875, -0.048125
#*# 	-0.080625, -0.048125, -0.037500, -0.014375, -0.061875, -0.066250, -0.091250
#*# 	-0.051875, -0.033750, -0.023750, -0.021875, -0.061250, -0.089375, -0.095625
#*# 	-0.076250, -0.031250, -0.020000, 0.000000, -0.043750, -0.050625, -0.085625
#*# 	-0.073750, -0.045000, -0.035000, -0.021875, -0.060625, -0.083125, -0.112500
#*# 	-0.092500, -0.049375, -0.029375, 0.008125, -0.018125, -0.035000, -0.086250
#*# 	-0.060625, -0.031250, -0.012500, 0.016250, -0.001875, -0.011250, -0.030625
#*# tension = 0.1
#*# mesh_x_pps = 2
#*# algo = bicubic
#*# min_x = 5.0
#*# min_y = 5.0
#*# y_count = 7
#*# mesh_y_pps = 2
#*# x_count = 7
#*# max_x = 201.98
#*# max_y = 230.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.905
#*# pid_ki = 1.647
#*# pid_kd = 101.837
#*#
#*# [probe]
#*# z_offset = 9.380
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.075
#*# pid_ki = 1.535
#*# pid_kd = 799.734
#*#
#*# [bed_mesh 70x70]
#*# version = 1
#*# points =
#*# 	  -0.075000, -0.082500, -0.091875, 0.018125, -0.121875, -0.123750, -0.147500
#*# 	  -0.045000, 0.108750, -0.051250, -0.071875, -0.028125, -0.002500, -0.143125
#*# 	  0.000000, -0.042500, -0.050000, -0.038750, 0.161250, 0.099375, -0.091875
#*# 	  0.025625, -0.018750, -0.027500, 0.000000, -0.075000, -0.081875, -0.036875
#*# 	  0.021250, -0.011875, -0.033750, -0.038750, -0.081875, -0.083125, -0.072500
#*# 	  -0.036250, 0.173125, -0.036250, -0.061250, -0.083125, -0.034375, -0.091875
#*# 	  -0.033750, -0.039375, -0.041875, -0.015625, -0.078750, -0.095000, -0.118750
#*# tension = 0.1
#*# min_x = 82.5
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 82.5
#*# x_count = 7
#*# max_y = 152.46
#*# mesh_x_pps = 2
#*# max_x = 152.46
#*#
#*# [bed_mesh 100C]
#*# version = 1
#*# points =
#*# 	-0.071875, -0.111875, -0.145000, -0.133125, -0.180625, -0.190625, -0.195625
#*# 	-0.129375, -0.086875, -0.080000, -0.026875, -0.087500, -0.086250, -0.152500
#*# 	-0.103750, -0.071250, -0.079375, -0.053750, -0.095000, -0.124375, -0.128125
#*# 	-0.090625, -0.046875, -0.052500, 0.000000, -0.065000, -0.080625, -0.136250
#*# 	-0.114375, -0.073125, -0.091250, -0.055000, -0.105000, -0.119375, -0.150000
#*# 	-0.115625, -0.075000, -0.082500, -0.031875, -0.078125, -0.085000, -0.149375
#*# 	-0.013750, -0.011250, -0.050000, -0.020000, -0.075625, -0.091875, -0.133125
#*# tension = 0.1
#*# min_x = 5.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 5.0
#*# x_count = 7
#*# max_y = 230.0
#*# mesh_x_pps = 2
#*# max_x = 201.98
#*#
#*# [bed_mesh 105C]
#*# version = 1
#*# points =
#*# 	-0.158750, -0.166250, -0.155625, -0.136875, -0.175625, -0.182500, -0.201250
#*# 	-0.167500, -0.124375, -0.075000, -0.045000, -0.063125, -0.071250, -0.125625
#*# 	-0.118750, -0.080625, -0.058750, -0.035000, -0.066875, -0.082500, -0.097500
#*# 	-0.125625, -0.075000, -0.035625, 0.000000, -0.023125, -0.035625, -0.090000
#*# 	-0.138125, -0.096875, -0.082500, -0.050625, -0.080000, -0.088750, -0.123125
#*# 	-0.172500, -0.127500, -0.080000, -0.038750, -0.041875, -0.048125, -0.118125
#*# 	-0.119375, -0.086875, -0.078125, -0.035000, -0.053125, -0.053125, -0.084375
#*# tension = 0.1
#*# min_x = 5.0
#*# algo = bicubic
#*# y_count = 7
#*# mesh_y_pps = 2
#*# min_y = 5.0
#*# x_count = 7
#*# max_y = 230.0
#*# mesh_x_pps = 2
#*# max_x = 201.98
